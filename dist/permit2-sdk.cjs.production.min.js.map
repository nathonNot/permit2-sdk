{"version":3,"file":"permit2-sdk.cjs.production.min.js","sources":["../src/constants.ts","../src/domain.ts","../src/allowanceTransfer.ts","../src/signatureTransfer.ts","../src/providers/AllowanceProvider.ts"],"sourcesContent":["import { BigNumber } from '@ethersproject/bignumber'\r\n\r\nexport const PERMIT2_ADDRESS = '0x3EA312569078c754cf907623A434589b3ac15D2A'\r\n\r\nexport const MaxUint48 = BigNumber.from('0xffffffffffff')\r\nexport const MaxUint160 = BigNumber.from('0xffffffffffffffffffffffffffffffffffffffff')\r\nexport const MaxUint256 = BigNumber.from('0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff')\r\n\r\n// alias max types for their usages\r\n// allowance transfer types\r\nexport const MaxAllowanceTransferAmount = MaxUint160\r\nexport const MaxAllowanceExpiration = MaxUint48\r\nexport const MaxOrderedNonce = MaxUint48\r\n\r\n// signature transfer types\r\nexport const MaxSignatureTransferAmount = MaxUint256\r\nexport const MaxUnorderedNonce = MaxUint256\r\nexport const MaxSigDeadline = MaxUint256\r\n\r\nexport const InstantExpiration: BigNumber = BigNumber.from(0)\r\n","import { TypedDataDomain, TypedDataField } from '@ethersproject/abstract-signer'\r\n\r\nconst PERMIT2_DOMAIN_NAME = 'Permit2'\r\n\r\nexport function permit2Domain(permit2Address: string, chainId: number): TypedDataDomain {\r\n  return {\r\n    name: PERMIT2_DOMAIN_NAME,\r\n    chainId,\r\n    verifyingContract: permit2Address,\r\n  }\r\n}\r\n\r\nexport type PermitData = {\r\n  domain: TypedDataDomain\r\n  types: Record<string, TypedDataField[]>\r\n  values: any\r\n}\r\n","import invariant from 'tiny-invariant'\r\nimport { TypedDataDomain, TypedDataField } from '@ethersproject/abstract-signer'\r\nimport { BigNumberish } from '@ethersproject/bignumber'\r\nimport { _TypedDataEncoder } from '@ethersproject/hash'\r\nimport { MaxSigDeadline, MaxOrderedNonce, MaxAllowanceTransferAmount, MaxAllowanceExpiration } from './constants'\r\nimport { permit2Domain } from './domain'\r\n\r\nexport interface PermitDetails {\r\n  token: string\r\n  amount: BigNumberish\r\n  expiration: BigNumberish\r\n  nonce: BigNumberish\r\n}\r\n\r\nexport interface PermitSingle {\r\n  details: PermitDetails\r\n  spender: string\r\n  sigDeadline: BigNumberish\r\n}\r\n\r\nexport interface PermitBatch {\r\n  details: PermitDetails[]\r\n  spender: string\r\n  sigDeadline: BigNumberish\r\n}\r\n\r\nexport type PermitSingleData = {\r\n  domain: TypedDataDomain\r\n  types: Record<string, TypedDataField[]>\r\n  values: PermitSingle\r\n}\r\n\r\nexport type PermitBatchData = {\r\n  domain: TypedDataDomain\r\n  types: Record<string, TypedDataField[]>\r\n  values: PermitBatch\r\n}\r\n\r\nconst PERMIT_DETAILS = [\r\n  { name: 'token', type: 'address' },\r\n  { name: 'amount', type: 'uint160' },\r\n  { name: 'expiration', type: 'uint48' },\r\n  { name: 'nonce', type: 'uint48' },\r\n]\r\n\r\nconst PERMIT_TYPES = {\r\n  PermitSingle: [\r\n    { name: 'details', type: 'PermitDetails' },\r\n    { name: 'spender', type: 'address' },\r\n    { name: 'sigDeadline', type: 'uint256' },\r\n  ],\r\n  PermitDetails: PERMIT_DETAILS,\r\n}\r\n\r\nconst PERMIT_BATCH_TYPES = {\r\n  PermitBatch: [\r\n    { name: 'details', type: 'PermitDetails[]' },\r\n    { name: 'spender', type: 'address' },\r\n    { name: 'sigDeadline', type: 'uint256' },\r\n  ],\r\n  PermitDetails: PERMIT_DETAILS,\r\n}\r\n\r\nfunction isPermit(permit: PermitSingle | PermitBatch): permit is PermitSingle {\r\n  return !Array.isArray(permit.details)\r\n}\r\n\r\nexport abstract class AllowanceTransfer {\r\n  /**\r\n   * Cannot be constructed.\r\n   */\r\n  private constructor() {}\r\n\r\n  // return the data to be sent in a eth_signTypedData RPC call\r\n  // for signing the given permit data\r\n  public static getPermitData(\r\n    permit: PermitSingle | PermitBatch,\r\n    permit2Address: string,\r\n    chainId: number\r\n  ): PermitSingleData | PermitBatchData {\r\n    invariant(MaxSigDeadline.gte(permit.sigDeadline), 'SIG_DEADLINE_OUT_OF_RANGE')\r\n\r\n    const domain = permit2Domain(permit2Address, chainId)\r\n    if (isPermit(permit)) {\r\n      validatePermitDetails(permit.details)\r\n      return {\r\n        domain,\r\n        types: PERMIT_TYPES,\r\n        values: permit,\r\n      }\r\n    } else {\r\n      permit.details.forEach(validatePermitDetails)\r\n      return {\r\n        domain,\r\n        types: PERMIT_BATCH_TYPES,\r\n        values: permit,\r\n      }\r\n    }\r\n  }\r\n\r\n  public static hash(permit: PermitSingle | PermitBatch, permit2Address: string, chainId: number): string {\r\n    const { domain, types, values } = AllowanceTransfer.getPermitData(permit, permit2Address, chainId)\r\n    return _TypedDataEncoder.hash(domain, types, values)\r\n  }\r\n}\r\n\r\nfunction validatePermitDetails(details: PermitDetails) {\r\n  invariant(MaxOrderedNonce.gte(details.nonce), 'NONCE_OUT_OF_RANGE')\r\n  invariant(MaxAllowanceTransferAmount.gte(details.amount), 'AMOUNT_OUT_OF_RANGE')\r\n  invariant(MaxAllowanceExpiration.gte(details.expiration), 'EXPIRATION_OUT_OF_RANGE')\r\n}\r\n","import invariant from 'tiny-invariant'\r\nimport { TypedDataDomain, TypedDataField } from '@ethersproject/abstract-signer'\r\nimport { BigNumberish } from '@ethersproject/bignumber'\r\nimport { _TypedDataEncoder } from '@ethersproject/hash'\r\nimport { permit2Domain } from './domain'\r\nimport { MaxSigDeadline, MaxUnorderedNonce, MaxSignatureTransferAmount } from './constants'\r\n\r\nexport interface Witness {\r\n  witness: any\r\n  witnessTypeName: string\r\n  witnessType: Record<string, TypedDataField[]>\r\n}\r\n\r\nexport interface TokenPermissions {\r\n  token: string\r\n  amount: BigNumberish\r\n}\r\n\r\nexport interface PermitTransferFrom {\r\n  permitted: TokenPermissions\r\n  spender: string\r\n  nonce: BigNumberish\r\n  deadline: BigNumberish\r\n}\r\n\r\nexport interface PermitBatchTransferFrom {\r\n  permitted: TokenPermissions[]\r\n  spender: string\r\n  nonce: BigNumberish\r\n  deadline: BigNumberish\r\n}\r\n\r\nexport type PermitTransferFromData = {\r\n  domain: TypedDataDomain\r\n  types: Record<string, TypedDataField[]>\r\n  values: PermitTransferFrom\r\n}\r\n\r\nexport type PermitBatchTransferFromData = {\r\n  domain: TypedDataDomain\r\n  types: Record<string, TypedDataField[]>\r\n  values: PermitBatchTransferFrom\r\n}\r\n\r\nconst TOKEN_PERMISSIONS = [\r\n  { name: 'token', type: 'address' },\r\n  { name: 'amount', type: 'uint256' },\r\n]\r\n\r\nconst PERMIT_TRANSFER_FROM_TYPES = {\r\n  PermitTransferFrom: [\r\n    { name: 'permitted', type: 'TokenPermissions' },\r\n    { name: 'spender', type: 'address' },\r\n    { name: 'nonce', type: 'uint256' },\r\n    { name: 'deadline', type: 'uint256' },\r\n  ],\r\n  TokenPermissions: TOKEN_PERMISSIONS,\r\n}\r\n\r\nconst PERMIT_BATCH_TRANSFER_FROM_TYPES = {\r\n  PermitBatchTransferFrom: [\r\n    { name: 'permitted', type: 'TokenPermissions[]' },\r\n    { name: 'spender', type: 'address' },\r\n    { name: 'nonce', type: 'uint256' },\r\n    { name: 'deadline', type: 'uint256' },\r\n  ],\r\n  TokenPermissions: TOKEN_PERMISSIONS,\r\n}\r\n\r\nfunction permitTransferFromWithWitnessType(witness: Witness): Record<string, TypedDataField[]> {\r\n  return {\r\n    PermitWitnessTransferFrom: [\r\n      { name: 'permitted', type: 'TokenPermissions' },\r\n      { name: 'spender', type: 'address' },\r\n      { name: 'nonce', type: 'uint256' },\r\n      { name: 'deadline', type: 'uint256' },\r\n      { name: 'witness', type: witness.witnessTypeName },\r\n    ],\r\n    TokenPermissions: TOKEN_PERMISSIONS,\r\n    ...witness.witnessType,\r\n  }\r\n}\r\n\r\nfunction permitBatchTransferFromWithWitnessType(witness: Witness): Record<string, TypedDataField[]> {\r\n  return {\r\n    PermitBatchWitnessTransferFrom: [\r\n      { name: 'permitted', type: 'TokenPermissions[]' },\r\n      { name: 'spender', type: 'address' },\r\n      { name: 'nonce', type: 'uint256' },\r\n      { name: 'deadline', type: 'uint256' },\r\n      { name: 'witness', type: witness.witnessTypeName },\r\n    ],\r\n    TokenPermissions: TOKEN_PERMISSIONS,\r\n    ...witness.witnessType,\r\n  }\r\n}\r\n\r\nfunction isPermitTransferFrom(permit: PermitTransferFrom | PermitBatchTransferFrom): permit is PermitTransferFrom {\r\n  return !Array.isArray(permit.permitted)\r\n}\r\n\r\nexport abstract class SignatureTransfer {\r\n  /**\r\n   * Cannot be constructed.\r\n   */\r\n  private constructor() {}\r\n\r\n  // return the data to be sent in a eth_signTypedData RPC call\r\n  // for signing the given permit data\r\n  public static getPermitData(\r\n    permit: PermitTransferFrom | PermitBatchTransferFrom,\r\n    permit2Address: string,\r\n    chainId: number,\r\n    witness?: Witness\r\n  ): PermitTransferFromData | PermitBatchTransferFromData {\r\n    invariant(MaxSigDeadline.gte(permit.deadline), 'SIG_DEADLINE_OUT_OF_RANGE')\r\n    invariant(MaxUnorderedNonce.gte(permit.nonce), 'NONCE_OUT_OF_RANGE')\r\n\r\n    const domain = permit2Domain(permit2Address, chainId)\r\n    if (isPermitTransferFrom(permit)) {\r\n      validateTokenPermissions(permit.permitted)\r\n      const types = witness ? permitTransferFromWithWitnessType(witness) : PERMIT_TRANSFER_FROM_TYPES\r\n      const values = witness ? Object.assign(permit, { witness: witness.witness }) : permit\r\n      return {\r\n        domain,\r\n        types,\r\n        values,\r\n      }\r\n    } else {\r\n      permit.permitted.forEach(validateTokenPermissions)\r\n      const types = witness ? permitBatchTransferFromWithWitnessType(witness) : PERMIT_BATCH_TRANSFER_FROM_TYPES\r\n      const values = witness ? Object.assign(permit, { witness: witness.witness }) : permit\r\n      return {\r\n        domain,\r\n        types,\r\n        values,\r\n      }\r\n    }\r\n  }\r\n\r\n  public static hash(\r\n    permit: PermitTransferFrom | PermitBatchTransferFrom,\r\n    permit2Address: string,\r\n    chainId: number,\r\n    witness?: Witness\r\n  ): string {\r\n    const { domain, types, values } = SignatureTransfer.getPermitData(permit, permit2Address, chainId, witness)\r\n    return _TypedDataEncoder.hash(domain, types, values)\r\n  }\r\n}\r\n\r\nfunction validateTokenPermissions(permissions: TokenPermissions) {\r\n  invariant(MaxSignatureTransferAmount.gte(permissions.amount), 'AMOUNT_OUT_OF_RANGE')\r\n}\r\n","import { BigNumber } from '@ethersproject/bignumber'\r\nimport { Provider } from '@ethersproject/providers'\r\nimport Permit2Abi from '../../abis/Permit2.json'\r\nimport { Contract } from '@ethersproject/contracts'\r\n\r\nexport interface AllowanceData {\r\n  amount: BigNumber\r\n  nonce: number\r\n  expiration: number\r\n}\r\n\r\nexport class AllowanceProvider {\r\n  private permit2: Contract\r\n\r\n  constructor(private provider: Provider, private permit2Address: string) {\r\n    this.permit2 = new Contract(this.permit2Address, Permit2Abi, this.provider)\r\n  }\r\n\r\n  async getAllowanceData(token: string, owner: string, spender: string): Promise<AllowanceData> {\r\n    return await this.permit2.allowance(owner, token, spender)\r\n  }\r\n\r\n  async getAllowance(token: string, owner: string, spender: string): Promise<BigNumber> {\r\n    return (await this.getAllowanceData(token, owner, spender)).amount\r\n  }\r\n\r\n  async getNonce(token: string, owner: string, spender: string): Promise<number> {\r\n    return (await this.getAllowanceData(token, owner, spender)).nonce\r\n  }\r\n\r\n  async getExpiration(token: string, owner: string, spender: string): Promise<number> {\r\n    return (await this.getAllowanceData(token, owner, spender)).expiration\r\n  }\r\n}\r\n"],"names":["MaxUint48","BigNumber","from","MaxUint160","MaxUint256","MaxAllowanceTransferAmount","MaxAllowanceExpiration","MaxOrderedNonce","MaxSignatureTransferAmount","MaxUnorderedNonce","MaxSigDeadline","InstantExpiration","permit2Domain","permit2Address","chainId","name","verifyingContract","PERMIT_DETAILS","type","PERMIT_TYPES","PermitSingle","PermitDetails","PERMIT_BATCH_TYPES","PermitBatch","AllowanceTransfer","getPermitData","permit","gte","sigDeadline","invariant","domain","Array","isArray","details","isPermit","validatePermitDetails","types","values","forEach","hash","_TypedDataEncoder","nonce","amount","expiration","TOKEN_PERMISSIONS","PERMIT_TRANSFER_FROM_TYPES","PermitTransferFrom","TokenPermissions","PERMIT_BATCH_TRANSFER_FROM_TYPES","PermitBatchTransferFrom","SignatureTransfer","witness","deadline","permitted","isPermitTransferFrom","validateTokenPermissions","PermitWitnessTransferFrom","witnessTypeName","witnessType","permitTransferFromWithWitnessType","Object","assign","PermitBatchWitnessTransferFrom","permitBatchTransferFromWithWitnessType","permissions","provider","this","permit2","Contract","Permit2Abi","_proto","getAllowanceData","token","owner","spender","_context","allowance","getAllowance","_context2","getNonce","_context3","getExpiration","_context4"],"mappings":"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"}